function pageReady(){navigator.getUserMedia?(videoCallButton=document.getElementById("videoCallButton"),remoteVideoElem=document.getElementById("remoteVideoElem"),localVideoElem=document.getElementById("localVideoElem"),endCallButton=document.getElementById("endCallButton"),handleVideo=document.getElementById("handleVideo"),handleAudio=document.getElementById("handleAudio"),applyAttributeDisabledButtons(),getCityId(),handleAudio.addEventListener("click",function(e){"muted"===handleAudio.value?(handleAudio.innerHTML='<span class="glyphicon glyphicon glyphicon-volume-up"></span> Audio',handleAudio.value="audio"):(handleAudio.innerHTML='<span class="glyphicon glyphicon glyphicon-volume-off"></span> Mudo',handleAudio.value="muted"),localVideoStream.getAudioTracks()[0].enabled=!localVideoStream.getAudioTracks()[0].enabled}),handleVideo.addEventListener("click",function(e){localVideoStream.getVideoTracks()[0].enabled=!localVideoStream.getVideoTracks()[0].enabled}),endCallButton.addEventListener("click",function(e){wsc.send(JSON.stringify({closeConnection:!0})),localVideoElem.src="",remoteVideoElem.src="",localVideoStream.getVideoTracks()[0].stop(),localVideoStream.getAudioTracks()[0].stop(),applyAttributeDisabledButtons()})):alert("seu navegador não suporta stream de video")}function prepareCall(){(peerConn=new RTCPeerConnection(peerConnCfg)).onicecandidate=onIceCandidateHandler,peerConn.onaddstream=onAddStreamHandler,removeAttributeDisabledButtons()}function getCityId(){document.getElementById("navigation").addEventListener("click",function(e){requestOfCall(e.target.id)})}function requestOfCall(e){let n=new XMLHttpRequest;n.open("POST","/server?id="+e,!0),n.send()}function initiateCall(){prepareCall(),navigator.getUserMedia({audio:!0,video:!0},function(e){localVideoStream=e,localVideoElem.srcObject=e,peerConn.addStream(localVideoStream),createAndSendOffer()},function(e){console.log("erro ao iniciar a chamada "+e)})}function answerCall(){prepareCall(),1==window.confirm("Chamada do agente remoto")&&navigator.getUserMedia({audio:!0,video:!0},function(e){localVideoStream=e,localVideoElem.srcObject=e,peerConn.addStream(localVideoStream),createAndSendAnswer()},function(e){console.log("erro ao enviar a resposta "+e)})}function createAndSendOffer(){peerConn.createOffer(function(e){let n=new RTCSessionDescription(e);peerConn.setLocalDescription(new RTCSessionDescription(n),function(){wsc.send(JSON.stringify({sdp:n}))},function(e){console.log(e)})},function(e){console.log("erro ao criar a conexão e enviar offer "+e)})}function createAndSendAnswer(){peerConn.createAnswer(function(e){let n=new RTCSessionDescription(e);peerConn.setLocalDescription(n,function(){wsc.send(JSON.stringify({sdp:n}))},function(e){console.log("erro ao criar resposta"+e)})},function(e){console.log(e)})}function onIceCandidateHandler(e){e&&e.candidate&&wsc.send(JSON.stringify({candidate:e.candidate}))}function onAddStreamHandler(e){remoteVideoElem.srcObject=e.stream}function endCall(){peerConn.close(),peerConn=null,localVideoStream&&localVideoStream.getTracks().forEach(function(e){e.stop()})}function notifyCall(){Notification.requestPermission(function(){Notification.permission="granted",new Notification("Agente Remoto",{body:"Atenda essa chamada"}).onclick=function(){window.open("https://localhost:5000/posto.html?id=sao-bento-sapucai")}})}function applyAttributeDisabledButtons(){handleAudio.setAttribute("disabled",""),handleVideo.setAttribute("disabled",""),endCallButton.setAttribute("disabled","")}function removeAttributeDisabledButtons(){handleAudio.removeAttribute("disabled"),handleVideo.removeAttribute("disabled"),endCallButton.removeAttribute("disabled")}navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia,window.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,window.SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition||window.mozSpeechRecognition||window.msSpeechRecognition||window.oSpeechRecognition;let remoteVideoElem=null,localVideoElem=null,localVideoStream=null,videoCallButton=null,handleVideo=null,handleAudio=null,endCallButton=null,peerConn=null,wss=null,sslSrv=null;document.getElementById("title").style.visibility="hidden";let urlOfClient=new URL(document.URL),wsc=new WebSocket("wss://"+location.host+"/"+urlOfClient.searchParams.get("id"));console.log(location.host);let peerConnCfg={iceServers:[{urls:"stun:stun.services.mozilla.com"},{urls:"stun:stun.l.google.com:19302"}]};wsc.onmessage=function(e){let n=null;peerConn||answerCall(),(n=JSON.parse(e.data)).sdp?peerConn.setRemoteDescription(new RTCSessionDescription(n.sdp)):n.candidate?peerConn.addIceCandidate(new RTCIceCandidate(n.candidate)):n.closeConnection&&endCall()},window.onload=pageReady();